<!DOCTYPE html>
<html>
<head>
    <title>Debug Notifications</title>
</head>
<body>
    <h1>Debug Push Notifications</h1>

    <button id="checkSubscribers">Check Subscriber Count</button>
    <button id="testWorkerHealth">Test Worker Health</button>
    <button id="checkMySubscription">Check My Subscription Status</button>
    <button id="checkEnvironment">Check Environment Variables</button>

    <pre id="output"></pre>

    <script>
        const workerUrl = 'https://masjid-push-notifications.rodeomasjid.workers.dev';
        const apiKey = window.localStorage.getItem('adminApiKey') || 'masjid_push_2025_secure_xyz789';
        const output = document.getElementById('output');

        function log(message) {
            output.textContent += new Date().toISOString() + ' - ' + message + '\n';
        }

        document.getElementById('checkSubscribers').onclick = async () => {
            log('\n=== Checking Subscriber Count ===');
            try {
                const response = await fetch(`${workerUrl}/api/stats`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                log(`Status: ${response.status}`);
                const result = await response.json();
                log(`Subscribers: ${JSON.stringify(result, null, 2)}`);

                if (result.subscriberCount === 0) {
                    log('❌ NO SUBSCRIBERS! This is likely why push notifications fail.');
                    log('   Someone needs to visit the main website and enable notifications first.');
                }
            } catch (error) {
                log(`Error: ${error.message}`);
            }
        };

        document.getElementById('testWorkerHealth').onclick = async () => {
            log('\n=== Testing Worker Health ===');
            try {
                const response = await fetch(`${workerUrl}/`);
                const text = await response.text();
                log(`Health check: ${text}`);
            } catch (error) {
                log(`Error: ${error.message}`);
            }
        };

        document.getElementById('checkMySubscription').onclick = async () => {
            log('\n=== My Subscription Status ===');
            const fcmToken = localStorage.getItem('fcmToken');
            const subscriberId = localStorage.getItem('subscriberId');
            const notificationsEnabled = localStorage.getItem('notificationsEnabled');

            log(`FCM Token: ${fcmToken ? 'Yes (' + fcmToken.substring(0, 20) + '...)' : 'No'}`);
            log(`Subscriber ID: ${subscriberId || 'No'}`);
            log(`Notifications Enabled: ${notificationsEnabled || 'No'}`);
            log(`Browser Permission: ${Notification.permission}`);
        };

        document.getElementById('checkEnvironment').onclick = async () => {
            log('\n=== Environment Variables Status ===');

            // Load env.js if not already loaded
            if (typeof window.ENV === 'undefined') {
                try {
                    await import('./js/env.js');
                } catch (e) {
                    log('Failed to load env.js: ' + e.message);
                }
            }

            if (window.ENV) {
                log(`PUSH_API_KEY: ${window.ENV.PUSH_API_KEY || 'Not set'}`);
                log(`CLOUDFLARE_WORKER_URL: ${window.ENV.CLOUDFLARE_WORKER_URL || 'Not set'}`);
                log(`VAPID_KEY: ${window.ENV.VAPID_KEY ? 'Set (' + window.ENV.VAPID_KEY.substring(0, 20) + '...)' : 'Not set'}`);
                log(`FIREBASE_API_KEY: ${window.ENV.FIREBASE_API_KEY || 'Not set'}`);

                // Test with the actual environment API key
                const envApiKey = window.ENV.PUSH_API_KEY;
                if (envApiKey && envApiKey !== 'PLACEHOLDER_PUSH_API_KEY') {
                    log(`\n=== Testing with ENV API Key ===`);
                    try {
                        const response = await fetch(`${workerUrl}/api/stats`, {
                            headers: { 'Authorization': `Bearer ${envApiKey}` }
                        });
                        const result = await response.json();
                        log(`Status: ${response.status}`);
                        log(`Result: ${JSON.stringify(result, null, 2)}`);
                    } catch (error) {
                        log(`Error with ENV API key: ${error.message}`);
                    }
                } else {
                    log('❌ ENV API key is missing or placeholder');
                }
            } else {
                log('❌ window.ENV not available');
            }
        };
    </script>
</body>
</html>